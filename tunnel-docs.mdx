# Tunneling script

Show your application to the world! This tool reverse forwards you applications on the localhost to a dynamically created URL that anybody can view at any point in the world.

## How this script works under the hood - The tunnel script

This script starts of by defining the domain of this tool, and the variable holding the path to the logfile.

```sh
#!/bin/bash

DOMAIN="domain name"
LOG_FILE="/home/tunnel/tunnel_debug.log"

echo "$(date): Script started" >> "$LOG_FILE"

```

Next, create a function that generates a random subdomain every time you call it:

```
function generate_subdomain() {
    cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 8 | head -n 1
}
```
 
After creating the random subdomain, next run a `handle_connection()` function that redirects the ports to port 80, if its http, and port 443 if its https. To do that, add this piece of code:

```
function handle_connection() {
    local subdomain=$(generate_subdomain)
    local local_port=$1

    log "Handling connection: $subdomain.$DOMAIN -> localhost:$local_port"
    echo "Tunnel established: https://$subdomain.$DOMAIN" | tee /home/tunnel/tunnel_url.txt

    # Set up iptables rule for this specific subdomain
    sudo iptables -t nat -A PREROUTING -p tcp -d "$subdomain.$DOMAIN" --dport 80 -j REDIRECT --to-port 8080
    sudo iptables -t nat -A PREROUTING -p tcp -d "$subdomain.$DOMAIN" --dport 443 -j REDIRECT --to-port 8080

    log "Tunnel active. Press Ctrl+C to exit."
    # Keep the script running
    while true; do
        sleep 10
    done

    log "Script running. Waiting for connection."
    handle_connection 3000

    log "Script ended"
}


```

The function above is made of different parts:
1. Create the `subdomain` and `local_port` variables
```
local subdomain=$(generate_subdomain)
local local_port=$1
```
- You create a random subdomain and save this subdomain to the `subdomain` variable
- Save the port a user passes as an argument to a variable `local_port`

2. Create the log files
```
log "Handling connection: $subdomain.$DOMAIN -> localhost:$local_port"
echo "Tunnel established: https://$subdomain.$DOMAIN" | tee /home/tunnel/tunnel_url.txt
```

3. Set up the iptables
```
# Set up iptables rule for this specific subdomain
sudo iptables -t nat -A PREROUTING -p tcp -d "$subdomain.$DOMAIN" --dport 80 -j REDIRECT --to-port 8080
sudo iptables -t nat -A PREROUTING -p tcp -d "$subdomain.$DOMAIN" --dport 443 -j REDIRECT --to-port 8080
```
- 
- 
- 

4. Create an uninteractive shell

```
log "Tunnel active. Press Ctrl+C to exit."
# Keep the script running
while true; do
    sleep 10
done
```

Keeps the sleep running forever.

5. Calls the `handle_connection` function and logs the ou:
```
log "Script running. Waiting for connection."
handle_connection 3000

log "Script ended"
```


## How this script works under the hood - Nginx Script
```conf
server {
    listen 80;
    server_name *.mobyme.site;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name *.mobyme.site;

    ssl_certificate /etc/letsencrypt/live/mobyme.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mobyme.site/privkey.pem;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

This Nginx configuration file, reverse proxies the `http://localhost:3000` to our URL `https://$host$request_uri`;


## How to use this script
To use this script, open your terminal, and run this command:

```
ssh -R 8080:localhost:3000 tunnel@mobyme.site
```

